<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Adjudicaci√≥n de Plazas ‚Äì UGEL Cusco</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Inter:wght@300;400;500&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:        #f0f4ff;
      --surface:   #ffffff;
      --surface2:  #f1f5f9;
      --azul:      #1e3a8a;
      --azul-mid:  #1d4ed8;
      --azul-vivo: #2563eb;
      --rojo:      #dc2626;
      --rojo-bg:   #fff1f1;
      --verde:     #16a34a;
      --verde-bg:  #f0fdf4;
      --texto:     #1e293b;
      --texto-dim: #64748b;
      --borde:     #e2e8f0;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--texto);
      min-height: 100vh;
      padding-bottom: 72px;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      background: linear-gradient(135deg, var(--azul) 0%, var(--azul-mid) 100%);
      padding: 16px 24px;
      display: flex; align-items: center; gap: 16px;
      position: sticky; top: 0; z-index: 90;
      box-shadow: 0 2px 12px rgba(30,58,138,0.25);
    }
    header img { height: 64px; flex-shrink: 0; }
    .header-text h2 {
      font-family: 'Montserrat', sans-serif;
      font-size: 0.68rem; font-weight: 700;
      color: #93c5fd; letter-spacing: 0.1em; text-transform: uppercase;
    }
    .header-text h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: clamp(0.95rem, 2.5vw, 1.55rem);
      font-weight: 900; color: #fff;
      line-height: 1.2; margin: 3px 0;
    }
    .live-badge {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 0.68rem; color: #fca5a5; font-weight: 700;
      letter-spacing: 0.06em;
    }
    .pulse {
      width: 7px; height: 7px; background: #ef4444;
      border-radius: 50%; animation: pulse 1.5s ease infinite; flex-shrink: 0;
    }
    @keyframes pulse {
      0%,100% { transform: scale(1); opacity: 1; }
      50%      { transform: scale(1.7); opacity: 0.4; }
    }

    hr.divider { border: none; border-top: 1px solid var(--borde); margin: 0 0 20px; }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    main { max-width: 1500px; margin: 0 auto; padding: 20px 14px; }

    /* ‚îÄ‚îÄ M√âTRICAS ‚îÄ‚îÄ */
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px; margin-bottom: 20px;
    }
    .metric-card {
      background: var(--surface);
      border: 1px solid var(--borde);
      border-top: 4px solid var(--azul-vivo);
      border-radius: 12px; padding: 16px 18px;
      box-shadow: 0 1px 6px rgba(30,58,138,0.07);
    }
    .metric-card.verde { border-top-color: var(--verde); }
    .metric-card.rojo  { border-top-color: var(--rojo); }
    .metric-label {
      font-size: 0.68rem; color: var(--texto-dim); margin-bottom: 5px;
      font-weight: 600; text-transform: uppercase; letter-spacing: .04em;
    }
    .metric-value {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.2rem; font-weight: 900; color: var(--azul); line-height: 1;
    }
    .metric-card.verde .metric-value { color: var(--verde); }
    .metric-card.rojo  .metric-value { color: var(--rojo); }
    .metric-sub { font-size: 0.65rem; color: var(--texto-dim); margin-top: 3px; }

    /* ‚îÄ‚îÄ FILTROS ‚îÄ‚îÄ */
    .filters-section {
      background: var(--surface); border: 1px solid var(--borde);
      border-radius: 12px; padding: 18px 20px; margin-bottom: 16px;
      box-shadow: 0 1px 6px rgba(30,58,138,0.06);
    }
    .filters-title { font-size: 1rem; font-weight: 700; color: var(--texto); margin-bottom: 14px; }
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    label { font-size: 0.72rem; color: var(--texto-dim); margin-bottom: 4px; display: block; font-weight: 600; }
    select, input[type="text"] {
      width: 100%; padding: 9px 11px;
      background: var(--bg); border: 1.5px solid var(--borde);
      border-radius: 8px; color: var(--texto);
      font-size: 0.84rem; font-family: 'Inter', sans-serif;
      outline: none; transition: border-color .2s, box-shadow .2s;
    }
    select:focus, input[type="text"]:focus {
      border-color: var(--azul-vivo);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.12);
    }

    /* ‚îÄ‚îÄ INFO BAR ‚îÄ‚îÄ */
    .info-bar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 8px; flex-wrap: wrap; gap: 6px;
    }
    .result-count { font-size: 0.78rem; color: var(--texto-dim); }
    .result-count strong { color: var(--azul); }
    .last-update { font-size: 0.7rem; color: var(--texto-dim); }
    .last-update span { color: var(--azul-vivo); font-weight: 600; }

    /* ‚îÄ‚îÄ TABLA ‚îÄ‚îÄ */
    .table-wrapper {
      background: var(--surface); border: 1px solid var(--borde);
      border-radius: 12px; overflow: hidden;
      box-shadow: 0 1px 6px rgba(30,58,138,0.07);
    }

    /* scroll horizontal m√≥vil + vertical */
    .table-scroll {
      overflow-x: auto;
      overflow-y: auto;
      max-height: 62vh;
      -webkit-overflow-scrolling: touch; /* scroll suave iOS */
    }

    table {
      width: max-content;   /* la tabla se expande seg√∫n su contenido */
      min-width: 100%;      /* nunca m√°s estrecha que el contenedor   */
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    thead { position: sticky; top: 0; z-index: 5; }
    thead th {
      background: var(--azul); color: #fff;
      font-family: 'Montserrat', sans-serif;
      font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: .07em; padding: 11px 14px; text-align: left;
      white-space: nowrap;   /* cabeceras en una sola l√≠nea */
      border-bottom: 2px solid var(--azul-mid);
    }
    tbody tr { border-bottom: 1px solid var(--borde); transition: background .1s; }
    tbody tr:hover { background: #eff6ff; }
    tbody td {
      padding: 8px 14px; vertical-align: middle; color: var(--texto);
      white-space: nowrap;   /* celdas en una l√≠nea ‚Üí activa scroll horizontal */
    }

    tr.disponible { background: var(--verde-bg); }
    tr.disponible:hover { background: #dcfce7; }
    tr.adjudicada { background: var(--rojo-bg); }
    tr.adjudicada:hover { background: #fee2e2; }

    .badge {
      display: inline-block; padding: 3px 10px; border-radius: 20px;
      font-size: 0.67rem; font-weight: 700; letter-spacing: .04em; white-space: nowrap;
    }
    .badge-disponible { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
    .badge-adjudicada { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }
    .badge-default    { background: var(--surface2); color: var(--texto-dim); }

    /* aviso scroll solo en m√≥vil */
    .scroll-hint {
      display: none;
      text-align: center; font-size: 0.7rem; color: var(--texto-dim);
      padding: 7px; background: var(--surface2); border-top: 1px solid var(--borde);
    }
    @media (max-width: 768px) {
      .scroll-hint { display: block; }
      header { padding: 12px 14px; gap: 12px; }
      header img { height: 50px; }
      main { padding: 14px 10px; }
    }

    /* ‚îÄ‚îÄ CARGA / ERROR ‚îÄ‚îÄ */
    #estado-carga { text-align: center; padding: 60px 20px; }
    .spinner {
      width: 36px; height: 36px;
      border: 4px solid var(--borde); border-top-color: var(--azul-vivo);
      border-radius: 50%; animation: spin .8s linear infinite;
      margin: 0 auto 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-box {
      background: #fef2f2; border: 1px solid #fca5a5;
      border-radius: 10px; padding: 16px 20px; color: #b91c1c; font-size: .85rem;
    }

    /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
    footer {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: var(--azul); color: rgba(255,255,255,0.8);
      text-align: center; font-size: 0.68rem; padding: 7px; z-index: 80;
      line-height: 1.7;
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body>

<header>
  <img src="https://ugelcusco.gob.pe/ws/wp-content/uploads/2026/02/LOGOOOO.fw_.png" alt="UGEL Cusco" onerror="this.style.display='none'"/>
  <div class="header-text">
    <h2>Unidad de Gesti√≥n Educativa Local Cusco</h2>
    <h1>Adjudicaci√≥n de Plazas ‚Äî Contrato Docente</h1>
    <div class="live-badge">
      <span class="pulse"></span>
      ‚óè ACTUALIZACI√ìN EN VIVO (CADA 5s)
    </div>
  </div>
</header>

<hr class="divider"/>

<main>

  <div class="metrics">
    <div class="metric-card">
      <div class="metric-label">üìã Total de Plazas</div>
      <div class="metric-value" id="m-total">‚Äî</div>
    </div>
    <div class="metric-card verde">
      <div class="metric-label">‚úÖ Disponibles</div>
      <div class="metric-value" id="m-disponibles">‚Äî</div>
      <div class="metric-sub" id="m-pct-disp"></div>
    </div>
    <div class="metric-card rojo">
      <div class="metric-label">üî¥ Adjudicadas</div>
      <div class="metric-value" id="m-adjudicadas">‚Äî</div>
      <div class="metric-sub" id="m-pct-adj"></div>
    </div>
    <div class="metric-card">
      <div class="metric-label">üîç Mostrando</div>
      <div class="metric-value" id="m-filtradas">‚Äî</div>
      <div class="metric-sub">con filtros actuales</div>
    </div>
  </div>

  <div class="filters-section">
    <div class="filters-title">üîç B√∫squeda Avanzada</div>
    <div class="filters-grid">
      <div>
        <label for="f-nivel">Nivel Educativo:</label>
        <select id="f-nivel"><option value="">TODOS</option></select>
      </div>
      <div>
        <label for="f-cargo">Cargo:</label>
        <select id="f-cargo"><option value="">TODOS</option></select>
      </div>
      <div>
        <label for="f-estado">Estado:</label>
        <select id="f-estado">
          <option value="">TODOS</option>
          <option value="DISPONIBLE">DISPONIBLE</option>
          <option value="ADJUDICADA">ADJUDICADA</option>
        </select>
      </div>
      <div>
        <label for="f-busca">B√∫squeda por IE y/o Especialidad:</label>
        <input type="text" id="f-busca" placeholder="Escriba aqu√≠..."/>
      </div>
    </div>
  </div>

  <div class="info-bar">
    <div class="result-count" id="result-count"></div>
    <div class="last-update">√öltima actualizaci√≥n: <span id="last-time">‚Äî</span></div>
  </div>

  <div class="table-wrapper">
    <div id="estado-carga">
      <div class="spinner"></div>
      <p style="color:var(--texto-dim);font-size:.85rem">Cargando datos‚Ä¶</p>
    </div>
    <div class="table-scroll" id="table-container" style="display:none">
      <table>
        <thead id="table-head"></thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
    <div class="scroll-hint">‚Üê Desliza para ver m√°s columnas ‚Üí</div>
  </div>

</main>

<footer>
  ¬© 2026 Equipo de Inform√°tica ‚Äì UGEL Cusco &nbsp;|&nbsp;
  Este tablero es meramente informativo. &nbsp;|&nbsp;
  La adjudicaci√≥n oficial se realiza en acto p√∫blico.
</footer>

<script>
  const SHEET_ID   = "1X78ctrqUH58bpjj57ibWucgpGrrw4NAG";
  const REFRESH_MS = 5_000;

  let allData = [], headers = [];
  let colEstado = -1, colNivel = -1, colCargo = -1;

  async function fetchData() {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&t=${Date.now()}`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    return parseCSV(await resp.text());
  }

  function parseCSV(text) {
    const parse = line => {
      const out = []; let cur = ""; let q = false;
      for (const ch of line) {
        if (ch === '"') { q = !q; }
        else if (ch === ',' && !q) { out.push(cur.trim()); cur = ""; }
        else cur += ch;
      }
      out.push(cur.trim());
      return out;
    };
    const lines = text.trim().split("\n");
    return { headers: parse(lines[0]), rows: lines.slice(1).map(parse) };
  }

  function findCol(name) {
    return headers.findIndex(h => h.toUpperCase().includes(name));
  }

  function populateSelect(id, colIdx) {
    const sel = document.getElementById(id);
    const cur = sel.value;
    const vals = [...new Set(allData.map(r => r[colIdx]).filter(Boolean))].sort();
    sel.innerHTML = '<option value="">TODOS</option>';
    vals.forEach(v => { const o = document.createElement("option"); o.value = o.textContent = v; sel.appendChild(o); });
    sel.value = cur;
  }

  function applyFilters() {
    const nivel  = document.getElementById("f-nivel").value.toLowerCase();
    const cargo  = document.getElementById("f-cargo").value.toLowerCase();
    const estado = document.getElementById("f-estado").value.toUpperCase();
    const busca  = document.getElementById("f-busca").value.toLowerCase();

    const filtered = allData.filter(row => {
      if (nivel  && colNivel  >= 0 && (row[colNivel]  || "").toLowerCase() !== nivel)  return false;
      if (cargo  && colCargo  >= 0 && (row[colCargo]  || "").toLowerCase() !== cargo)  return false;
      if (estado && colEstado >= 0 && (row[colEstado] || "").trim().toUpperCase() !== estado) return false;
      if (busca  && !row.some(c => (c || "").toLowerCase().includes(busca))) return false;
      return true;
    });

    renderTable(filtered);
    updateMetrics(filtered.length);
  }

  function renderTable(filtered) {
    const thead = document.getElementById("table-head");
    const tbody = document.getElementById("table-body");

    if (!thead.innerHTML)
      thead.innerHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

    if (!filtered.length) {
      tbody.innerHTML = `<tr><td colspan="${headers.length}"
        style="text-align:center;padding:40px;color:var(--texto-dim);white-space:normal">
        No se encontraron plazas con los filtros seleccionados.</td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map(row => {
      const est = colEstado >= 0 ? (row[colEstado] || "").trim().toUpperCase() : "";
      const cls = est === "ADJUDICADA" ? "adjudicada" : est === "DISPONIBLE" ? "disponible" : "";
      const cells = row.map((cell, i) => {
        if (i === colEstado) {
          const bc = est === "DISPONIBLE" ? "badge-disponible"
                   : est === "ADJUDICADA" ? "badge-adjudicada" : "badge-default";
          return `<td><span class="badge ${bc}">${cell || "‚Äî"}</span></td>`;
        }
        return `<td>${cell !== undefined && cell !== "" ? cell : "‚Äî"}</td>`;
      }).join("");
      return `<tr class="${cls}">${cells}</tr>`;
    }).join("");
  }

  function updateMetrics(filtradas) {
    const total = allData.length;
    const disp  = colEstado >= 0 ? allData.filter(r => (r[colEstado]||"").trim().toUpperCase()==="DISPONIBLE").length : 0;
    const adj   = colEstado >= 0 ? allData.filter(r => (r[colEstado]||"").trim().toUpperCase()==="ADJUDICADA").length : 0;
    document.getElementById("m-total").textContent       = total;
    document.getElementById("m-disponibles").textContent = disp;
    document.getElementById("m-adjudicadas").textContent = adj;
    document.getElementById("m-filtradas").textContent   = filtradas;
    document.getElementById("m-pct-disp").textContent    = total ? `${Math.round(disp/total*100)}% del total` : "";
    document.getElementById("m-pct-adj").textContent     = total ? `${Math.round(adj/total*100)}% del total` : "";
    document.getElementById("result-count").innerHTML    =
      `Mostrando <strong>${filtradas}</strong> de <strong>${total}</strong> plazas`;
  }

  async function refresh() {
    try {
      const { headers: hdrs, rows } = await fetchData();
      const first = headers.length === 0;
      headers = hdrs; allData = rows;
      colEstado = findCol("ESTADO");
      colNivel  = findCol("NIVEL");
      colCargo  = findCol("CARGO");

      if (colNivel >= 0) populateSelect("f-nivel", colNivel);
      if (colCargo >= 0) populateSelect("f-cargo", colCargo);

      if (first) {
        document.getElementById("estado-carga").style.display    = "none";
        document.getElementById("table-container").style.display = "block";
        ["f-nivel","f-cargo","f-estado","f-busca"].forEach(id =>
          document.getElementById(id).addEventListener("input", applyFilters));
      }

      applyFilters();
      document.getElementById("last-time").textContent =
        new Date().toLocaleTimeString("es-PE", {hour:"2-digit", minute:"2-digit", second:"2-digit"});

    } catch (err) {
      if (!allData.length)
        document.getElementById("estado-carga").innerHTML =
          `<div class="error-box">‚ùå Error: ${err.message}<br/>
           <small>Verifica que la hoja sea p√∫blica (Compartir ‚Üí Cualquier persona con el enlace).</small></div>`;
      console.error(err);
    }
  }

  refresh();
  setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
