<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Adjudicaci√≥n de Plazas ‚Äì UGEL Cusco</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Inter:wght@300;400;500&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:        #0e1117;
      --surface:   #1a1f2e;
      --surface2:  #262c3e;
      --azul:      #1e3a8a;
      --azul-vivo: #2563eb;
      --rojo:      #ef4444;
      --rojo-bg:   rgba(239,68,68,0.12);
      --verde:     #22c55e;
      --verde-bg:  rgba(34,197,94,0.10);
      --texto:     #e2e8f0;
      --texto-dim: #94a3b8;
      --borde:     #2e3650;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--texto);
      min-height: 100vh;
      padding-bottom: 72px;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--borde);
      padding: 20px 32px;
      display: flex; align-items: center; gap: 20px;
      position: sticky; top: 0; z-index: 90;
    }
    header img { height: 70px; flex-shrink: 0; }
    .header-text h2 {
      font-family: 'Montserrat', sans-serif;
      font-size: 0.72rem; font-weight: 700;
      color: var(--texto-dim); letter-spacing: 0.1em; text-transform: uppercase;
    }
    .header-text h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: clamp(1.1rem, 2.8vw, 1.7rem);
      font-weight: 900; color: #fff;
      line-height: 1.2; margin: 4px 0;
    }
    .live-badge {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 0.72rem; color: var(--rojo); font-weight: 700;
      letter-spacing: 0.06em;
    }
    .pulse {
      width: 8px; height: 8px; background: var(--rojo);
      border-radius: 50%; animation: pulse 1.5s ease infinite;
    }
    @keyframes pulse {
      0%,100% { transform: scale(1); opacity: 1; }
      50%      { transform: scale(1.6); opacity: 0.4; }
    }

    hr.divider { border: none; border-top: 1px solid var(--borde); margin: 0 0 24px; }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    main { max-width: 1500px; margin: 0 auto; padding: 24px 20px; }

    /* ‚îÄ‚îÄ M√âTRICAS ‚îÄ‚îÄ */
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(155px, 1fr));
      gap: 14px; margin-bottom: 24px;
    }
    .metric-card {
      background: var(--surface); border: 1px solid var(--borde);
      border-radius: 12px; padding: 18px 20px;
    }
    .metric-label { font-size: 0.7rem; color: var(--texto-dim); margin-bottom: 6px; }
    .metric-value {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.4rem; font-weight: 900; color: #fff; line-height: 1;
    }
    .metric-sub { font-size: 0.68rem; color: var(--texto-dim); margin-top: 3px; }

    /* ‚îÄ‚îÄ FILTROS ‚îÄ‚îÄ */
    .filters-section {
      background: var(--surface); border: 1px solid var(--borde);
      border-radius: 12px; padding: 20px 22px; margin-bottom: 18px;
    }
    .filters-title { font-size: 1.1rem; font-weight: 700; color: #fff; margin-bottom: 14px; }
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
    }
    label { font-size: 0.75rem; color: var(--texto-dim); margin-bottom: 5px; display: block; }
    select, input[type="text"] {
      width: 100%; padding: 10px 12px;
      background: var(--bg); border: 1.5px solid var(--borde);
      border-radius: 8px; color: var(--texto);
      font-size: 0.85rem; font-family: 'Inter', sans-serif;
      outline: none; transition: border-color .2s, box-shadow .2s;
    }
    select:focus, input[type="text"]:focus {
      border-color: var(--azul-vivo);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.2);
    }
    select option { background: var(--surface2); }

    /* ‚îÄ‚îÄ INFO BAR ‚îÄ‚îÄ */
    .info-bar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 10px; flex-wrap: wrap; gap: 6px;
    }
    .result-count { font-size: 0.8rem; color: var(--texto-dim); }
    .result-count strong { color: #fff; }
    .last-update { font-size: 0.72rem; color: var(--texto-dim); }
    .last-update span { color: var(--azul-vivo); font-weight: 600; }

    /* ‚îÄ‚îÄ TABLA ‚îÄ‚îÄ */
    .table-wrapper {
      background: var(--surface); border: 1px solid var(--borde);
      border-radius: 12px; overflow: hidden;
    }
    .table-scroll { overflow-x: auto; max-height: 58vh; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    thead { position: sticky; top: 0; z-index: 5; }
    thead th {
      background: var(--surface2);
      color: var(--texto-dim);
      font-size: 0.68rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: .07em; padding: 11px 14px; text-align: left;
      white-space: nowrap; border-bottom: 1px solid var(--borde);
    }
    tbody tr { border-bottom: 1px solid var(--borde); transition: background .1s; }
    tbody tr:hover { background: var(--surface2); }
    tbody td { padding: 9px 14px; vertical-align: middle; color: var(--texto); }

    tr.disponible { background: var(--verde-bg); }
    tr.disponible:hover { background: rgba(34,197,94,0.16); }
    tr.adjudicada { background: var(--rojo-bg); }
    tr.adjudicada:hover { background: rgba(239,68,68,0.18); }

    .badge {
      display: inline-block; padding: 3px 10px; border-radius: 20px;
      font-size: 0.68rem; font-weight: 700; letter-spacing: .04em;
    }
    .badge-disponible { background: rgba(34,197,94,0.18); color: var(--verde); border: 1px solid rgba(34,197,94,0.3); }
    .badge-adjudicada { background: rgba(239,68,68,0.18); color: var(--rojo);  border: 1px solid rgba(239,68,68,0.3); }
    .badge-default    { background: var(--surface2); color: var(--texto-dim); }

    /* ‚îÄ‚îÄ CARGA / ERROR ‚îÄ‚îÄ */
    #estado-carga { text-align: center; padding: 60px 20px; }
    .spinner {
      width: 38px; height: 38px;
      border: 4px solid var(--borde); border-top-color: var(--azul-vivo);
      border-radius: 50%; animation: spin .8s linear infinite;
      margin: 0 auto 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-box {
      background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.4);
      border-radius: 10px; padding: 16px 20px; color: #fca5a5; font-size: .85rem;
    }

    /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
    footer {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: var(--azul); color: rgba(255,255,255,0.75);
      text-align: center; font-size: 0.7rem; padding: 8px; z-index: 80;
      line-height: 1.7;
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--borde); border-radius: 3px; }
  </style>
</head>
<body>

<header>
  <img src="https://ugelcusco.gob.pe/ws/wp-content/uploads/2026/02/LOGOOOO.fw_.png" alt="UGEL Cusco" onerror="this.style.display='none'"/>
  <div class="header-text">
    <h2>Unidad de Gesti√≥n Educativa Local Cusco</h2>
    <h1>Adjudicaci√≥n de Plazas ‚Äî Contrato Docente</h1>
    <div class="live-badge">
      <span class="pulse"></span>
      ‚óè ACTUALIZACI√ìN EN VIVO (CADA 5s)
    </div>
  </div>
</header>

<hr class="divider"/>

<main>

  <div class="metrics">
    <div class="metric-card">
      <div class="metric-label">üìã Total de Plazas</div>
      <div class="metric-value" id="m-total">‚Äî</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">‚úÖ Disponibles</div>
      <div class="metric-value" id="m-disponibles" style="color:var(--verde)">‚Äî</div>
      <div class="metric-sub" id="m-pct-disp"></div>
    </div>
    <div class="metric-card">
      <div class="metric-label">üî¥ Adjudicadas</div>
      <div class="metric-value" id="m-adjudicadas" style="color:var(--rojo)">‚Äî</div>
      <div class="metric-sub" id="m-pct-adj"></div>
    </div>
    <div class="metric-card">
      <div class="metric-label">üîç Mostrando</div>
      <div class="metric-value" id="m-filtradas">‚Äî</div>
      <div class="metric-sub">con filtros actuales</div>
    </div>
  </div>

  <div class="filters-section">
    <div class="filters-title">üîç B√∫squeda Avanzada</div>
    <div class="filters-grid">
      <div>
        <label for="f-nivel">Nivel Educativo:</label>
        <select id="f-nivel"><option value="">TODOS</option></select>
      </div>
      <div>
        <label for="f-cargo">Cargo:</label>
        <select id="f-cargo"><option value="">TODOS</option></select>
      </div>
      <div>
        <label for="f-estado">Estado:</label>
        <select id="f-estado">
          <option value="">TODOS</option>
          <option value="DISPONIBLE">DISPONIBLE</option>
          <option value="ADJUDICADA">ADJUDICADA</option>
        </select>
      </div>
      <div>
        <label for="f-busca">B√∫squeda por IE y/o Especialidad:</label>
        <input type="text" id="f-busca" placeholder="Escriba aqu√≠..."/>
      </div>
    </div>
  </div>

  <div class="info-bar">
    <div class="result-count" id="result-count"></div>
    <div class="last-update">√öltima actualizaci√≥n: <span id="last-time">‚Äî</span></div>
  </div>

  <div class="table-wrapper">
    <div id="estado-carga">
      <div class="spinner"></div>
      <p style="color:var(--texto-dim);font-size:.85rem">Cargando datos‚Ä¶</p>
    </div>
    <div class="table-scroll" id="table-container" style="display:none">
      <table>
        <thead id="table-head"></thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>

</main>

<footer>
  ¬© 2026 Equipo de Inform√°tica ‚Äì UGEL Cusco &nbsp;|&nbsp;
  Este tablero es meramente informativo. &nbsp;|&nbsp;
  La adjudicaci√≥n oficial se realiza en acto p√∫blico.
</footer>

<script>
  const SHEET_ID   = "1X78ctrqUH58bpjj57ibWucgpGrrw4NAG";
  const REFRESH_MS = 5_000; // ‚Üê 5 segundos

  let allData = [], headers = [];
  let colEstado = -1, colNivel = -1, colCargo = -1;

  async function fetchData() {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&t=${Date.now()}`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    return parseCSV(await resp.text());
  }

  function parseCSV(text) {
    const parse = line => {
      const out = []; let cur = ""; let q = false;
      for (const ch of line) {
        if (ch === '"') { q = !q; }
        else if (ch === ',' && !q) { out.push(cur.trim()); cur = ""; }
        else cur += ch;
      }
      out.push(cur.trim());
      return out;
    };
    const lines = text.trim().split("\n");
    return { headers: parse(lines[0]), rows: lines.slice(1).map(parse) };
  }

  function findCol(name) {
    return headers.findIndex(h => h.toUpperCase().includes(name));
  }

  function populateSelect(id, colIdx) {
    const sel = document.getElementById(id);
    const cur = sel.value;
    const vals = [...new Set(allData.map(r => r[colIdx]).filter(Boolean))].sort();
    sel.innerHTML = '<option value="">TODOS</option>';
    vals.forEach(v => { const o = document.createElement("option"); o.value = o.textContent = v; sel.appendChild(o); });
    sel.value = cur;
  }

  function applyFilters() {
    const nivel  = document.getElementById("f-nivel").value.toLowerCase();
    const cargo  = document.getElementById("f-cargo").value.toLowerCase();
    const estado = document.getElementById("f-estado").value.toUpperCase();
    const busca  = document.getElementById("f-busca").value.toLowerCase();

    const filtered = allData.filter(row => {
      if (nivel  && colNivel  >= 0 && (row[colNivel]  || "").toLowerCase() !== nivel)  return false;
      if (cargo  && colCargo  >= 0 && (row[colCargo]  || "").toLowerCase() !== cargo)  return false;
      if (estado && colEstado >= 0 && (row[colEstado] || "").trim().toUpperCase() !== estado) return false;
      if (busca  && !row.some(c => (c || "").toLowerCase().includes(busca))) return false;
      return true;
    });

    renderTable(filtered);
    updateMetrics(filtered.length);
  }

  function renderTable(filtered) {
    const thead = document.getElementById("table-head");
    const tbody = document.getElementById("table-body");

    if (!thead.innerHTML)
      thead.innerHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

    if (!filtered.length) {
      tbody.innerHTML = `<tr><td colspan="${headers.length}"
        style="text-align:center;padding:40px;color:var(--texto-dim)">
        No se encontraron plazas con los filtros seleccionados.</td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map(row => {
      const est = colEstado >= 0 ? (row[colEstado] || "").trim().toUpperCase() : "";
      const cls = est === "ADJUDICADA" ? "adjudicada" : est === "DISPONIBLE" ? "disponible" : "";
      const cells = row.map((cell, i) => {
        if (i === colEstado) {
          const bc = est === "DISPONIBLE" ? "badge-disponible"
                   : est === "ADJUDICADA" ? "badge-adjudicada" : "badge-default";
          return `<td><span class="badge ${bc}">${cell || "‚Äî"}</span></td>`;
        }
        return `<td>${cell !== undefined && cell !== "" ? cell : "‚Äî"}</td>`;
      }).join("");
      return `<tr class="${cls}">${cells}</tr>`;
    }).join("");
  }

  function updateMetrics(filtradas) {
    const total = allData.length;
    const disp  = colEstado >= 0 ? allData.filter(r => (r[colEstado]||"").trim().toUpperCase()==="DISPONIBLE").length : 0;
    const adj   = colEstado >= 0 ? allData.filter(r => (r[colEstado]||"").trim().toUpperCase()==="ADJUDICADA").length : 0;
    document.getElementById("m-total").textContent       = total;
    document.getElementById("m-disponibles").textContent = disp;
    document.getElementById("m-adjudicadas").textContent = adj;
    document.getElementById("m-filtradas").textContent   = filtradas;
    document.getElementById("m-pct-disp").textContent    = total ? `${Math.round(disp/total*100)}% del total` : "";
    document.getElementById("m-pct-adj").textContent     = total ? `${Math.round(adj/total*100)}% del total` : "";
    document.getElementById("result-count").innerHTML    =
      `Mostrando <strong>${filtradas}</strong> de <strong>${total}</strong> plazas`;
  }

  async function refresh() {
    try {
      const { headers: hdrs, rows } = await fetchData();
      const first = headers.length === 0;
      headers = hdrs; allData = rows;
      colEstado = findCol("ESTADO");
      colNivel  = findCol("NIVEL");
      colCargo  = findCol("CARGO");

      if (colNivel >= 0) populateSelect("f-nivel", colNivel);
      if (colCargo >= 0) populateSelect("f-cargo", colCargo);

      if (first) {
        document.getElementById("estado-carga").style.display   = "none";
        document.getElementById("table-container").style.display = "block";
        ["f-nivel","f-cargo","f-estado","f-busca"].forEach(id =>
          document.getElementById(id).addEventListener("input", applyFilters));
      }

      applyFilters();
      document.getElementById("last-time").textContent =
        new Date().toLocaleTimeString("es-PE", {hour:"2-digit", minute:"2-digit", second:"2-digit"});

    } catch (err) {
      if (!allData.length)
        document.getElementById("estado-carga").innerHTML =
          `<div class="error-box">‚ùå Error: ${err.message}<br/>
           <small>Verifica que la hoja sea p√∫blica (Compartir ‚Üí Cualquier persona con el enlace).</small></div>`;
      console.error(err);
    }
  }

  refresh();
  setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
